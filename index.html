<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
<div id="vis"></div>
<script>
const spec = {
  "$schema":"https://vega.github.io/schema/vega-lite/v5.json",
  "width":960, "height":560,
  "title":{"text":"Australian Domestic Airlines â€” Cancellation Rate by Departure Airport","anchor":"start"},
  "projection":{"type":"mercator"},
  "layer":[
    /* Basemap: Australia from your TopoJSON */
    {
      "data":{"url":"ne_110m.json","format":{"type":"topojson","feature":"ne_110m_admin_0_countries"}},
      "transform":[
        {"filter":"datum.properties.ISO_A3=='AUS' || datum.properties.ADM0_A3=='AUS' || datum.properties.SU_A3=='AUS'"}
      ],
      "mark":{"type":"geoshape","fill":"#f0f5f9","stroke":"#cbd5e1"}
    },

    /* Proportional symbols + labels */
    {
      "data":{"url":"DomesticAirlines.csv"},   
      "transform":[
        {"calculate":"indexof(datum.Departing_Port,' (')>-1 ? slice(datum.Departing_Port,0,indexof(datum.Departing_Port,' (')) : datum.Departing_Port","as":"PortNorm"},
        {"aggregate":[
          {"op":"sum","field":"Cancellations","as":"c"},
          {"op":"sum","field":"Departures_On_Time","as":"on"},
          {"op":"sum","field":"Departures_Delayed","as":"del"}
        ],"groupby":["PortNorm"]},
        {"calculate":"toNumber(datum.on)+toNumber(datum.del)+toNumber(datum.c)","as":"tot"},
        {"filter":"datum.tot>0"},
        {"calculate":"round((datum.c/datum.tot)*100*10)/10","as":"rate"}, 
        /* inline lookup: 8 capital-city coordinates */
        {"lookup":"PortNorm","from":{"data":{"values":[
          {"port":"Sydney","lat":-33.9399,"lon":151.1753},
          {"port":"Melbourne","lat":-37.6690,"lon":144.8410},
          {"port":"Brisbane","lat":-27.3842,"lon":153.1175},
          {"port":"Adelaide","lat":-34.9382,"lon":138.5376},
          {"port":"Perth","lat":-31.9403,"lon":115.9672},
          {"port":"Hobart","lat":-42.8361,"lon":147.5090},
          {"port":"Canberra","lat":-35.3069,"lon":149.1950},
          {"port":"Darwin","lat":-12.4081,"lon":130.8727}
        ]},"key":"port","fields":["lat","lon"]}},
        {"filter":"isValid(datum.lat) && isValid(datum.lon)"}
      ],
      "layer":[
        {
          "mark":{"type":"text","dx":8,"dy":0,"fontSize":11,"color":"#111827","align":"left","baseline":"middle"},
          "encoding":{
            "longitude":{"field":"lon"},
            "latitude":{"field":"lat"},
            "text":{"field":"PortNorm"},
            "tooltip":[
              {"field":"PortNorm","title":"Airport"},
              {"field":"tot","title":"Total Departures","format":","},
              {"field":"c","title":"Cancellations","format":","},
              {"field":"rate","title":"Cancel Rate (%)","format":".1f"}
            ]
          }
        },
        {
          "mark":{"type":"circle","opacity":0.9,"stroke":"#334155","strokeWidth":0.6,"zindex":1},
          "encoding":{
            "longitude":{"field":"lon"},
            "latitude":{"field":"lat"},
            "size":{
              "field":"tot",
              "scale":{"type":"sqrt","range":[24,140]},
              "title":"Total Departures",
              "legend":{"symbolSize":900,"labelFontSize":12,"titleFontSize":13}
            },
            "color":{
              "field":"rate",
              "type":"quantitative",               
              "scale":{"scheme":"reds"},
              "title":"Cancellation Rate (%)",
              "legend":{"format":".1f","gradientLength":200,"gradientThickness":12}
            },
            "tooltip":[
              {"field":"PortNorm","title":"Airport"},
              {"field":"tot","title":"Total Departures","format":","},
              {"field":"c","title":"Cancellations","format":","},
              {"field":"rate","title":"Cancel Rate (%)","format":".1f"}
            ]
          }
        }
      ]
    }
  ],
  "config":{"legend":{"orient":"bottom"},"view":{"stroke":null}}
};
vegaEmbed("#vis", spec, {actions:false});
</script>
</body>
</html>
